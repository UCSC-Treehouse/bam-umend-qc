# Treehouse RNA-Seq QC
QC of aligned reads for the Treehouse RNA-Seq pipeline

## Overview
We have added tools to the pipeline that will allow us to get a quick overview of the quality of the data as well as generate information that we can refer to for more in-depth analysis. This document describes the tools required, the output to retain, and useful values for a summary report, as well as the application of a threshold below which to warn the end user of quality concerns.

## Existing tools
FastQC is already run as part of the RNA_Seq pipeline as of version 2, and the fastq data zip file is retained in more recent versions.
STAR is already run as part of the experimental processing. Among the files to save described below will be a STAR output log.

## New tool and analysis overview
We added samblaster to the pipeline for the purpose of marking duplicates, and RSeQC for the purposes of 1) counting how reads are distributed across gene features and 2) assessing gene body coverage. RSeQC is sensitive to marked duplicates, so the RSeQC measurements are also informative about the effect of duplication.

We apply a minimum threshold of 10Million to the estimated count of non-duplicate, uniquely mapped exonic reads. After the theshold is applied, a file named like the exonic read counting file (readDist.txt) is appended with FAIL_qc.txt or PASS_qc.txt. A failure means that the sample may not contain sufficient information for the analysis.

## Future directions
We'd like to automatically generate a report for each sample that incldues RSeQC output from this step, the STAR output log and FastQC, which will involve integrating outputs. We'd like to be able to generate an overview report for a a group of samples. We have manually triggered overview plots that incorporate FASTQC, STAR, and RSeQC results at the batch level. We plan to develop a systematic approach and add this to the pipeline.

# Implementation

## Output to retain
Generated by existing pipline:
* The fastqc zip file for each FastQC run should be retained (~500kb) The *Log.final.out for each STAR alignment (~2kb)
Generated by the steps added here:
* readDist.txt, The output of read_distribution.py (~1kb)
* readDist.txt_PASS_qc.txt, or readDist.txt_FAIL_qc.txt, the output of parseReadDist.R, (<1kb)
* rnaAligned.out.md.sorted.geneBodyCoverage.curves.pdf and rnaAligned.out.md.sorted.geneBodyCoverage.txt, generated by geneBody_coverage.py (~10kb total)
* rnaAligned.sortedByCoord.md.bam, the coordinate-sorted and genome-aligned bam file generated by samblaster in which duplicates have been marked (in place of the initial genome-aligned bam generated by star that is currently being retained). This file is named rnaAligned.sortedByCoord.md.bam (roughly equal in size to the compressed fastq input)
The bam index file rnaAligned.sortedByCoord.md.bam.bai (approximately 1/100th the size of the corresponding bam file)
In the final output, the files should be named in a way that they are computationally tractable (e.g. naming the output of read_distribution.py something like [sample].readDistribution.txt)
IMPORTANT: if readDist.txt_FAIL_qc.txt exists, please prefix the output tar file with "FAIL"

## Docker and usage
Image located on hub.docker.com
       REPOSITORY: hbeale/treehouse_bam_qc TAG: 1.0
       IMAGE ID: b5ff42617c18

## Expected input file
The container expects to find a bam file named rnaAligned.sortedByCoord.out.bam in the directory mapped to /data. It expects the bam file to have been generated by STAR with the arguments:
       
       --outSAMtype BAM SortedByCoordinate --outSAMunmapped Within KeepPair
 
The gene definition reference file is already in the container.

## Example Run command
       docker run --rm --name qc \
              -v /path/to/output:/data \
              -v /path/to/bam:/data/rnaAligned.sortedByCoord.out.bam \
              hbeale/treehouse_bam_qc:1.0 runQC.sh

## Example expected stdout
       samblaster: Version 0.1.22
       samblaster: Inputting from stdin
       samblaster: Outputting to stdout
       samblaster: Loaded 195 header sequence entries.
       samblaster: Marked 3870 of 1885937 (0.21%) read ids as duplicates using 36960k
       memory in 4.368S CPU seconds and 23S wall time.
       Writing sorted chunks to temporary directory...
       [==============================================================================]
       Merging sorted chunks...
       [==============================================================================]
       @ 2016-09-19 21:18:15: Read BED file (reference gene model) ...
       @ 2016-09-19 21:18:34: Total 92523 transcripts loaded
       @ 2016-09-19 21:18:34: Get BAM file(s) ...
              /data/rnaAligned.out.md.sorted.bam
       @ 2016-09-19 21:18:34: Processing rnaAligned.out.md.sorted.bam ...
              81000 transcripts finished
              Sample  Skewness
              rnaAligned.out.md.sorted        -2.30062518384
        @ 2016-09-19 21:27:22: Running R script ...
        null device
              1
        processing /ref/hg38_GENCODE_v23.bed ... Done
        processing /data/rnaAligned.out.md.sorted.bam ... Finished
  
